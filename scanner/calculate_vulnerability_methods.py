#python 3

import math
from usefull_methods import *

#
#
#       Calculate Vulnerability Score And Grade Methods
#
#

def device_vulnerability_score(cvsss, number_open_filtered_ports):
    w = 70.0
    k = 5   #scaler for open services
    v = sum(cvsss)
    p = number_open_filtered_ports

    fv = 0
    if v > 0: fv = math.log(v)

    gv = 0
    if p > 0: gv = k*math.log(p)

    score = w / (w + fv + gv)

    return score

def network_vulnerability_score(router_score, device_scores, number_of_devices):
    r = router_score
    d = device_scores
    n = number_of_devices
    w = 15 #weight of router compared to a single device

    if n != 0:
        return ((w*r + sum(d))/(w + n))*100
    return r*100

def grade(percentage):
    #A: 90-100
    #B: 80-89
    #C: 70-79
    #D: 60-69
    #F: <60

    if percentage > 90:
        return "A"
    elif 80 <= percentage < 90:
        return "B"
    elif 70 <= percentage < 80:
        return "B"
    elif 60 <= percentage < 70:
        return "C"
    else:
        return "F"


def cal_device_vuln_score(device):
    device_cvsss = []
    number_of_services = 0

    for cve in device['host_CVE_list']:
        if type(cve) == dict:
            device_cvsss.append(cve['CVSS_Severity'])

    for service in device['Services']:
        for cve in service['service_CVE_list']:
            if type(cve) == dict:
                device_cvsss.append(cve['CVSS_Severity'])
        number_of_services += 1

    device_score = device_vulnerability_score(device_cvsss, number_of_services)

    return device_score


# extract list of device cvss scores
def calc_vuln_scores_grade():
    log_activity('\tCalculating vulnerability scores and vulnerability grades')

    global Report

    #
    # Device vulnerability Scores
    #
    device_scores = []
    for device in Report['Devices']:
        device_score = cal_device_vuln_score(device)

        # set Device 'Vulnerability_Score' in Report
        device['Vulnerability_Score'] = device_score
        device_scores.append(device_score)

    #
    #   Router vulnerability Score
    #
    router_score = cal_device_vuln_score(Report['Router'])

    # set Router 'Vulnerability_Score' in Report
    Report['Router']['Vulnerability_Score'] = router_score

    #
    #   Network vulnerability Score
    #
    network_score = network_vulnerability_score(router_score, device_scores, len(Report['Devices']))
    network_grade = grade(network_score)

    # set Network 'Vulnerability_Score' and Vulnerability_Grade' in Report
    Report['Vulnerability_Score'] = network_score
    Report['Vulnerability_Grade'] = network_grade

    #*temporary*
    #print("Router: %f" % router_score)
    #print("Devices: " + str(device_scores))
    #print ("Vulnerability_Score: %f" % Report['Vulnerability_Score'])
    #print ("Vulnerability_Grade: %s" % Report['Vulnerability_Grade'])